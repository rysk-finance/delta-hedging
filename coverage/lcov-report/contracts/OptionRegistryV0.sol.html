<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts/OptionRegistryV0.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> OptionRegistryV0.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">91.95% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>80/87</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">63.89% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>23/36</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">70.59% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>12/17</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">91.95% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>80/87</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">15×</span>
<span class="cline-any cline-yes">13×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">5×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">pragma solidity &gt;=0.8.9;
import "./tokens/ERC20.sol";
import "./interfaces/IERC20.sol";
import { Types } from "./libraries/Types.sol";
import "./interfaces/AddressBookInterface.sol";
import "@openzeppelin/contracts/access/Ownable.sol";
import { IController} from "./interfaces/GammaInterface.sol";
import { OptionsCompute } from "./libraries/OptionsCompute.sol";
import {OpynInteractions} from "./libraries/OpynInteractions.sol";
import { SafeTransferLib } from "./libraries/SafeTransferLib.sol";
import "hardhat/console.sol";
&nbsp;
contract OptionRegistryV0 is Ownable {
&nbsp;
    // public versioning of the contract for external use
    string public constant VERSION = "1.0";
    uint8 private constant OPYN_DECIMALS = 8;
    // address of the usd asset used
    // TODO: maybe make into flexible usd
    address internal usd;
    // address of the opyn oTokenFactory for oToken minting
    address internal oTokenFactory;
    // address of the gammaController for oToken operations
    address internal gammaController;
    // address of the opyn addressBook for accessing important opyn modules
    AddressBookInterface internal addressBook;
    // address of the marginPool, contract for storing options collateral
    address internal marginPool;
    // address of the rysk liquidity pools
    address internal liquidityPool;
    // amount of openInterest (assets) held in a specific series
    mapping(address =&gt; uint) public openInterest;
    // amount of assets held in a series by an address
    mapping(address =&gt; mapping(address =&gt; uint)) public writers;
    // information of a series
    mapping(address =&gt; Types.OptionSeries) public seriesInfo;
    // vaultId that is responsible for a specific series address
    mapping(address =&gt; uint) public vaultIds;
    // issuance hash mapped against the series address
    mapping(bytes32 =&gt; address) seriesAddress;
&nbsp;
    event OptionTokenCreated(address token);
    event SeriesRedeemed(address series, uint underlyingAmount, uint strikeAmount);
    event OptionsContractOpened(address indexed series, uint256 vaultId, uint256 optionsAmount);
    event OptionsContractClosed(address indexed series, uint256 vaultId, uint256 closedAmount);
    event OptionsContractSettled(address indexed series);
&nbsp;
    /**
     * @dev Throws if called by any account other than the liquidity pool.
     */
    modifier onlyLiquidityPool() {
        require(msg.sender == liquidityPool, "!liquidityPool");
        _;
    }
&nbsp;
    constructor(address usdToken, address _oTokenFactory, address _gammaController, address _marginPool, address _liquidityPool, address _addressBook) {
      usd = usdToken;
      oTokenFactory = _oTokenFactory;
      gammaController = _gammaController;
      marginPool = _marginPool;
      liquidityPool = _liquidityPool;
      addressBook = AddressBookInterface(_addressBook);
    }
&nbsp;
    /**
     * @notice Set the liquidity pool address
     * @param  _newLiquidityPool set the liquidityPool address
     */
<span class="fstat-no" title="function not covered" >    function setLiquidityPool(address _newLiquidityPool) external onlyOwner {</span>
<span class="cstat-no" title="statement not covered" >      liquidityPool = _newLiquidityPool</span>;
    }
&nbsp;
    /**
     * @notice Either retrieves the option token if it already exists, or deploy it
     * @param  underlying is the address of the underlying asset of the option
     * @param  strikeAsset is the address of the collateral asset of the option
     * @param  expiration is the expiry timestamp of the option
     * @param  isPut the type of option
     * @param  strike is the strike price of the option - 1e18 format
     * @param collateral is the address of the asset to collateralize the option with
     * @return the address of the option
     */
    function issue(address underlying, address strikeAsset, uint expiration, bool isPut, uint strike, address collateral) external onlyLiquidityPool returns (address) {
        // deploy an oToken contract address
        <span class="missing-if-branch" title="else path not taken" >E</span>require(expiration &gt; block.timestamp, "Already expired");
        // create option storage hash
        address u = underlying;
        address s = strikeAsset;
        bytes32 issuanceHash = getIssuanceHash(underlying, strikeAsset, expiration, isPut, strike);
        //address collateralAsset = collateral == address(0) ? usd : collateral;
        // check for an opyn oToken if it doesn't exist deploy it
        address series = OpynInteractions.getOrDeployOtoken(oTokenFactory, collateral, underlying, strikeAsset, formatStrikePrice(strike, collateral), expiration, isPut);
        // store the option data as a hash
        seriesInfo[series] = Types.OptionSeries(expiration, isPut, strike, u, s, collateral);
        seriesAddress[issuanceHash] = series;
        emit OptionTokenCreated(series);
        return series;
    }
&nbsp;
    /**
     * @notice Retrieves the option token if it exists
     * @param  underlying is the address of the underlying asset of the option
     * @param  strikeAsset is the address of the collateral asset of the option
     * @param  expiration is the expiry timestamp of the option
     * @param  isPut the type of option
     * @param  strike is the strike price of the option - 1e18 format
     * @param collateral is the address of the asset to collateralize the option with
     * @return the address of the option
     */
<span class="fstat-no" title="function not covered" >    function getOtoken(address underlying, address strikeAsset, uint expiration, bool isPut, uint strike, address collateral) external onlyLiquidityPool returns (address) {</span>
        // deploy an oToken contract address
<span class="cstat-no" title="statement not covered" >        require(expiration &gt; block.timestamp, "Already expired")</span>;
        // check for an opyn oToken
<span class="cstat-no" title="statement not covered" >        address series = OpynInteractions.getOtoken(oTokenFactory, collateral, underlying, strikeAsset, formatStrikePrice(strike, collateral), expiration, isPut);</span>
<span class="cstat-no" title="statement not covered" >        return series;</span>
    }
    /**
     * @notice Converts strike price to 1e8 format and floors least significant digits if needed
     * @param  strikePrice strikePrice in 1e18 format
     * @param  collateral address of collateral asset
     * @return if the transaction succeeded
     */
    function formatStrikePrice(
        uint256 strikePrice,
        address collateral
    ) internal view returns (uint) {
        // convert strike to 1e8 format
        uint price = strikePrice / (10**10);
        uint collateralDecimals = IERC20(collateral).decimals();
        if (collateralDecimals &gt;= OPYN_DECIMALS) return price;
        uint difference = OPYN_DECIMALS - collateralDecimals;
        // round floor strike to prevent errors in Gamma protocol
        return price / (10**difference) * (10**difference);
    }
&nbsp;
    /**
     * @notice Open an options contract using collateral from the liquidity pool
     * @param  _series the address of the option token to be created
     * @param  amount the amount of options to deploy
     * @param  collateralAmount the amount of collateral for the option
     * @dev only callable by the liquidityPool
     * @return if the transaction succeeded
     * @return the amount of collateral taken from the liquidityPool
     */
    function open(address _series, uint amount, uint collateralAmount) external onlyLiquidityPool returns (bool, uint256) {
        // make sure the options are ok to open
        Types.OptionSeries memory series = seriesInfo[_series];
        <span class="missing-if-branch" title="else path not taken" >E</span>require(block.timestamp &lt; series.expiration, "Options can not be opened after expiration");
        // transfer collateral to this contract, collateral will depend on the option type
      if (!series.isPut) {
          SafeTransferLib.safeTransferFrom(series.underlying, msg.sender, address(this), collateralAmount);
      } else {
          SafeTransferLib.safeTransferFrom(series.strikeAsset, msg.sender, address(this), collateralAmount);
      }
        // mint the option token following the opyn interface
        IController controller = IController(gammaController);
        // check if a vault for this option already exists
        uint256 vaultId = vaultIds[_series];
        <span class="missing-if-branch" title="else path not taken" >E</span>if (vaultId == 0) {
          vaultId = (controller.getAccountVaultCounter(address(this))) + 1;
        } 
        uint256 mintAmount = OpynInteractions.createShort(gammaController, marginPool, _series, collateralAmount, vaultId, amount);
        // transfer the option to the liquidity pool
        SafeTransferLib.safeTransfer(ERC20(_series), msg.sender, mintAmount);
        openInterest[_series] += amount;
        writers[_series][msg.sender] += amount;
        vaultIds[_series] = vaultId;
        emit OptionsContractOpened(_series, vaultId, mintAmount);
        return (true, collateralAmount);
    }
&nbsp;
    /**
     * @notice Close an options contract (oToken) before it has expired
     * @param  _series the address of the option token to be burnt
     * @param  amount the amount of options to burn
     * @dev only callable by the liquidityPool
     * @return if the transaction succeeded
     */
    function close(address _series, uint amount) external onlyLiquidityPool returns (bool, uint256) {
        // withdraw and burn
        Types.OptionSeries memory series = seriesInfo[_series];
        // make sure the option hasnt expired yet
        <span class="missing-if-branch" title="else path not taken" >E</span>require(block.timestamp &lt; series.expiration, "Option already expired");
        // make sure the option was issued by this account
        <span class="missing-if-branch" title="else path not taken" >E</span>require(openInterest[_series] &gt;= amount);
        // get the vault id
        uint256 vaultId = vaultIds[_series];
        // transfer the oToken back to this account
        SafeTransferLib.safeTransferFrom(_series, msg.sender, address(this), OptionsCompute.convertToDecimals(amount, IERC20(_series).decimals()));
        // burn the oToken tracking the amount of collateral returned
        uint256 collatReturned = OpynInteractions.burnShort(gammaController, marginPool, _series, amount, vaultId);
&nbsp;
        <span class="missing-if-branch" title="else path not taken" >E</span>require(writers[_series][msg.sender] &gt;= collatReturned, "Caller did not write sufficient amount");
        writers[_series][msg.sender] -= collatReturned;
        openInterest[_series] -= collatReturned;
&nbsp;
        if (!series.isPut) {
          transferOutUnderlying(series, collatReturned);
        } else {
          transferOutStrike(series, collatReturned);
        }
        emit OptionsContractClosed(_series, vaultId, amount);
        return (true, collatReturned);
    }
&nbsp;
    /**
     * @notice Settle an options vault
     * @param  _series the address of the option token to be burnt
     * @return if the transaction succeeded
     * @dev only callable by the liquidityPool
     */
    function settle(address _series) external onlyLiquidityPool returns (bool) {
        Types.OptionSeries memory series = seriesInfo[_series];
        <span class="missing-if-branch" title="else path not taken" >E</span>require(series.expiration != 0, "non-existent series");
        // check that the option has expired
        <span class="missing-if-branch" title="else path not taken" >E</span>require(block.timestamp &gt; series.expiration, "option not past expiry");
        // get the vault
        uint256 vaultId = vaultIds[_series];
        // settle the vault
        uint256 collatReturned = OpynInteractions.settle(gammaController, vaultId);
        openInterest[_series] = 0;
        writers[_series][msg.sender] = 0;
        // transfer the collateral back to the liquidity pool
        if (!series.isPut) {
          transferOutUnderlying(series, collatReturned);
        } else {
          transferOutStrike(series, collatReturned);
        }
        emit OptionsContractSettled(_series);
        return true;
    }
&nbsp;
    /**
     * @notice Redeem oTokens for the locked collateral
     * @param  _series the address of the option token to be burnt and redeemed
     * @return amount returned
     */
    function redeem(address _series) external returns (uint256) {
        Types.OptionSeries memory series = seriesInfo[_series];
        <span class="missing-if-branch" title="else path not taken" >E</span>require(series.expiration != 0, "non-existent series");
        // check that the option has expired
        <span class="missing-if-branch" title="else path not taken" >E</span>require(block.timestamp &gt; series.expiration, "option not past expiry");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(IERC20(_series).balanceOf(msg.sender) &gt; 0, "insufficient option tokens");
        uint256 seriesBalance = IERC20(_series).balanceOf(msg.sender);
        // transfer the oToken back to this account
        SafeTransferLib.safeTransferFrom(_series, msg.sender, address(this), IERC20(_series).balanceOf(msg.sender));
        // redeem
        uint256 amount = OpynInteractions.redeem(gammaController, marginPool, _series, seriesBalance);
        return amount;
    }
&nbsp;
    /**
     * @notice Send collateral funds for an option to be minted
     * @param  series details of the option series
     * @param  amount amount of options to mint
     * @return amount transferred
     */
    function getCollateral(Types.OptionSeries memory series, uint256 amount) external view returns (uint256) {
      uint256 collateralAmount;
      if (!series.isPut) {
          collateralAmount = amount;
      } else {
          collateralAmount = OptionsCompute.computeEscrow(amount, series.strike, IERC20(series.strikeAsset).decimals());
      }
      return collateralAmount;
    }
    /**
     * @notice Send collateral funds to the liquidityPool
     * @param  _series address of the oToken
     * @param  amount amount of underlying to transfer
     */
   function transferOutUnderlying(Types.OptionSeries memory _series, uint amount) internal {
     SafeTransferLib.safeTransfer(ERC20(_series.underlying), msg.sender, amount);
    }
&nbsp;
    /**
     * @notice Send collateral funds to the liquidityPool
     * @param  _series address of the oToken
     * @param  amount amount of strike to transfer
     */
   function transferOutStrike(Types.OptionSeries memory _series, uint amount) internal {
     SafeTransferLib.safeTransfer(ERC20(_series.strikeAsset), msg.sender, amount);
   }
&nbsp;
  /*********
    GETTERS
   *********/
&nbsp;
<span class="fstat-no" title="function not covered" >   function getSeriesAddress(bytes32 issuanceHash) public view returns (address) {</span>
<span class="cstat-no" title="statement not covered" >     return seriesAddress[issuanceHash];</span>
   }
&nbsp;
<span class="fstat-no" title="function not covered" >   function getSeriesInfo(address series)</span>
     public
     view
     returns (Types.OptionSeries memory) {
<span class="cstat-no" title="statement not covered" >     return seriesInfo[series];</span>
   }
&nbsp;
<span class="fstat-no" title="function not covered" >   function getIssuanceHash(Types.OptionSeries memory _series) public pure returns (bytes32) {</span>
<span class="cstat-no" title="statement not covered" >     return getIssuanceHash(_series.underlying, _series.strikeAsset, _series.expiration, _series.isPut, _series.strike);</span>
   }
&nbsp;
    /**
     * Helper function for computing the hash of a given issuance.
     */
    function getIssuanceHash(address underlying, address strikeAsset, uint expiration, bool isPut, uint strike)
      internal
      pure
      returns(bytes32)
    {
      return keccak256(
         abi.encodePacked(underlying, strikeAsset, expiration, isPut, strike)
      );
    }
&nbsp;
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Apr 07 2022 23:34:57 GMT+0100 (Western European Summer Time)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
